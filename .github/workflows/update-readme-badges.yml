name: Update README Badges (Advanced)

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
  workflow_dispatch:

# Required for committing and pushing from the workflow (public or private repos)
permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use PAT for private repos or when org restricts GITHUB_TOKEN; otherwise GITHUB_TOKEN is enough
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Read package.json and update README
        run: |
          # Criar script Node.js para processar package.json
          cat > update-badges.js << 'EOF'
          const fs = require('fs');
          const pkg = require('./package.json');

          // Função para encode URL
          const encode = (str) => encodeURIComponent(str || '');

          // Extrair informações
          const version = pkg.version || '0.0.0';
          const nodeVersion = pkg.engines?.node || '>=18';

          // Versões de dependências
          // -- front-hub
          const frontHubVersion = pkg.dependencies?.['@resultadosdigitais/front-hub'] || '0.0.0';
          const frontHubCliVersion = pkg.devDependencies?.['@resultadosdigitais/front-hub-cli'] || '0.0.0';
          const frontHubCommonsVersion = pkg.devDependencies?.['@resultadosdigitais/front-hub-commons'] || '0.0.0';

          // -- tangram
          const tangramVersion = pkg.dependencies?.['@resultadosdigitais/tangram-components'] || '0.0.0';


          // https://img.shields.io/badge/front--hub-7.2-blue?style=for-the-badge
          // Criar badges usando shields.io
          const badges = [
            `![Version](https://img.shields.io/badge/version-${encode(version)}-blue.svg?style=for-the-badge)`,
            `![Node](https://img.shields.io/badge/node-${encode(nodeVersion)}-brightgreen.svg?style=for-the-badge)`,
          ];

          // adicionar badge do fronthub se existir
          if (frontHubVersion) {
            badges.push(`![Front Hub](https://img.shields.io/badge/front--hub-${encode(frontHubVersion)}-blue.svg?style=for-the-badge)`);
          }
          if (frontHubCliVersion) {
            badges.push(`![Front Hub CLI](https://img.shields.io/badge/front--hub--cli-${encode(frontHubCliVersion)}-blue.svg?style=for-the-badge)`);
          }
          if (frontHubCommonsVersion) {
            badges.push(`![Front Hub Commons](https://img.shields.io/badge/front--hub--commons-${encode(frontHubCommonsVersion)}-blue.svg?style=for-the-badge)`);
          }

          // adicionar badge do tangram se existir
          if (tangramVersion) {
            badges.push(`![Tangram](https://img.shields.io/badge/tangram-${encode(tangramVersion)}-blue?style=for-the-badge)`);
          }


          // Criar seção de badges
          const badgeSection = `<!-- BADGES:START -->\n${badges.join('\n')}\n<!-- BADGES:END -->`;

          // Ler README existente ou logar erro se não existir
          let readme = "";
          try {
            readme = fs.readFileSync('README.md', 'utf-8');
          } catch (error) {
            console.error('❌ README.md não encontrado!');
            return;
          }

          // Atualizar badges
          if (readme.includes('<!-- BADGES:START -->')) {
            // Substituir badges existentes
            readme = readme.replace(
              /<!-- BADGES:START -->[\s\S]*?<!-- BADGES:END -->/,
              badgeSection
            );
          } else {
            // Inserir badges após a primeira linha (título)
            const lines = readme.split('\n');
            lines.splice(1, 0, '', badgeSection, '');
            readme = lines.join('\n');
          }

          // Salvar README atualizado
          fs.writeFileSync('README.md', readme);
          console.log('✅ README.md atualizado com sucesso!');
          EOF
          
          # Executar script
          node update-badges.js
          
          # Limpar arquivo temporário
          rm update-badges.js
      
      - name: Commit and push changes
        run: |
          # Use the author of the push (or the user who dispatched the workflow) for the commit
          git config --local user.email "readme-bot@users.noreply.github.com"
          git config --local user.name "readme-bot"
          
          if git diff --quiet README.md; then
            echo "✓ Nenhuma alteração detectada no README.md"
          else
            git add README.md
            git commit -m "docs: update README badges [skip ci]"
            git push
            echo "✓ README.md commitado e enviado com sucesso!"
          fi